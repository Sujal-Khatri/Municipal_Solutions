{% extends 'base.html' %}

{% block content %}
<h1>Create New Discussion Post</h1>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}

    <!-- Hidden input for storing map location if not rendered by {{ form.as_p }} -->
    <input type="hidden" id="id_location" name="location">

    <button type="submit" class="btn btn-primary">Submit</button>
    <a href="{% url 'discussions' %}" class="btn btn-secondary">Cancel</a>
</form>

<h5>Select Location on Map (Kathmandu)</h5>
<div id="map" style="height: 400px; margin-bottom: 20px;"></div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Kathmandu-Restricted Map -->
<script>
    const minLat = 27.6, maxLat = 27.8;
    const minLng = 85.25, maxLng = 85.38;

    var map = L.map('map').setView([27.7172, 85.3240], 13);  // Kathmandu center

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var marker;

    map.on('click', function(e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;

        if (lat >= minLat && lat <= maxLat && lng >= minLng && lng <= maxLng) {
            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng).addTo(map);
            }

            document.getElementById("id_location").value = lat + "," + lng;
        } else {
            alert("❌ Please select a location within Kathmandu.");
        }
    });
</script>
{% endblock %}